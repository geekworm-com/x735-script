#!/bin/bash

set -e

SLEEP=${1:-4}

readonly BUTTON=20
readonly GPIO_PATH="/sys/class/gpio"
readonly BUTTON_PATH="${GPIO_PATH}/gpio${BUTTON}"

readonly INVALID_CLI_ARG_TYPE="151"

terminate() {
    local -r msg=$1
    local -r err_code=${2:-160}
    echo "${msg}" >&2
    exit "${err_code}"
}

if ! [[ $SLEEP =~ ^[0-9\.]+$ ]] ; then
   terminate "error: sleep time not a number" "${INVALID_CLI_ARG_TYPE}"
fi

# export / unexport a GPIO
un_export_gpio() {
   local -r state="$1"

   echo "${BUTTON}" > "${GPIO_PATH}/${state}"
}

modify_gpio_val() {
   local -r file="$1"
   local -r value="$2"

   echo "${value}" > "${BUTTON_PATH}/${file}"
}

gpio_cleanup() {
   un_export_gpio "unexport"
   terminate "unexpected error..."
}


# Main method
function __main__ {
  un_export_gpio "export"
  trap 'gpio_cleanup' EXIT

  modify_gpio_val "direction" "out"
  modify_gpio_val "value" "1"

  echo "Your device will shutting down in ${SLEEP} seconds..."
  /bin/sleep $SLEEP

  modify_gpio_val "value" "0"
}

__main__